<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>main/runners/mocha/MochaRunner.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="InputLoader.html">InputLoader</a><ul class='methods'><li data-type='method'><a href="InputLoader.html#.loadInputFromEnvironment">loadInputFromEnvironment</a></li></ul></li><li><a href="MochaRunner.html">MochaRunner</a><ul class='methods'><li data-type='method'><a href="MochaRunner.html#run">run</a></li></ul></li><li><a href="ProcessHandler.html">ProcessHandler</a><ul class='methods'><li data-type='method'><a href="ProcessHandler.html#assert">assert</a></li><li data-type='method'><a href="ProcessHandler.html#mxFails">mxFails</a></li><li data-type='method'><a href="ProcessHandler.html#noFails">noFails</a></li></ul></li><li><a href="Validator.html">Validator</a><ul class='methods'><li data-type='method'><a href="Validator.html#__addBrowser">__addBrowser</a></li><li data-type='method'><a href="Validator.html#__authenticate">__authenticate</a></li><li data-type='method'><a href="Validator.html#__commandChaining">__commandChaining</a></li><li data-type='method'><a href="Validator.html#__commands">__commands</a></li><li data-type='method'><a href="Validator.html#__commandSelector">__commandSelector</a></li><li data-type='method'><a href="Validator.html#__countAllInCompleteOccurrences">__countAllInCompleteOccurrences</a></li><li data-type='method'><a href="Validator.html#__countAllViolationOccurrences">__countAllViolationOccurrences</a></li><li data-type='method'><a href="Validator.html#__countViolationOccurrences">__countViolationOccurrences</a></li><li data-type='method'><a href="Validator.html#__selectOption">__selectOption</a></li><li data-type='method'><a href="Validator.html#__validate">__validate</a></li><li data-type='method'><a href="Validator.html#closeAllBrowsers">closeAllBrowsers</a></li><li data-type='method'><a href="Validator.html#createChrome">createChrome</a></li><li data-type='method'><a href="Validator.html#createDefaultBrowser">createDefaultBrowser</a></li><li data-type='method'><a href="Validator.html#createFirefox">createFirefox</a></li><li data-type='method'><a href="Validator.html#getValidationErrors">getValidationErrors</a></li><li data-type='method'><a href="Validator.html#getViolationsOnPage">getViolationsOnPage</a></li><li data-type='method'><a href="Validator.html#getWarnings">getWarnings</a></li><li data-type='method'><a href="Validator.html#getWarningsOnPage">getWarningsOnPage</a></li><li data-type='method'><a href="Validator.html#printReportToConsole">printReportToConsole</a></li><li data-type='method'><a href="Validator.html#run">run</a></li><li data-type='method'><a href="Validator.html#startNewBrowser">startNewBrowser</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ASSERT_WARNINGS">ASSERT_WARNINGS</a></li><li><a href="global.html#BROWSER">BROWSER</a></li><li><a href="global.html#CHROME_BINARY">CHROME_BINARY</a></li><li><a href="global.html#DEBUG">DEBUG</a></li><li><a href="global.html#DEFINITION_FILE">DEFINITION_FILE</a></li><li><a href="global.html#DETAILED_REPORT">DETAILED_REPORT</a></li><li><a href="global.html#FIREFOX_BINARY">FIREFOX_BINARY</a></li><li><a href="global.html#HEADLESS">HEADLESS</a></li><li><a href="global.html#NAME">NAME</a></li><li><a href="global.html#runTestSuite">runTestSuite</a></li><li><a href="global.html#TAGS">TAGS</a></li><li><a href="global.html#TIMEOUT">TIMEOUT</a></li><li><a href="global.html#WAIT_TIMEOUT">WAIT_TIMEOUT</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">main/runners/mocha/MochaRunner.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Mocha = require('mocha');
const Test = Mocha.Test;
const Suite = Mocha.Suite;

const _ = require('lodash');
const assert = require('assert');
const Validator = require('../../validator');
const {NAME, TIMEOUT, ASSERT_WARNINGS} = require('../../globals');
const {log, error} = require('../../log/log');

/**
 * Executes the validator with a custom Mocha-runner
 * that dynamically creates tests for each page.
 *
 * See the {@link run} method for example usage.
 *
 * @class MochaRunner
 * @constructor
 * @public
 */
function MochaRunner() { }

/**
 * Returns a promise that will return validation results once
 * validation is complete.
 *
 * @param input Input definition object. Must be loaded from {@link InputLoader.js}
 * @param config Configuration to use when running the tests. Overrides the default values. See example.
 * @returns {Promise&lt;*>} Returns a resultset when complete.
 *
 * @example &lt;caption>Configuration example with the MochaRunner&lt;/caption>

    async function configure() {
        // set options
        const name = "a11y-test";
        const headless = true;
        const warnings = true;
        const detailedReport = false;

        const MochaRunner = require('nav-ally/MochaRunner');
        const runner = new MochaRunner();
        const results = await runner.run({links: ['http://some-url.com'] }, {name, headless, warnings, detailedReport});
        return results;
    }

    @example &lt;caption>Without configuration&lt;/caption>

     async function run() {
        const MochaRunner = require('nav-ally/MochaRunner');
        const runner = new MochaRunner();
        const result = await runner.run();
        assert.ok(result.fails &lt; result.passes);
    }


     @example &lt;caption>With a custom callback function&lt;/caption>

     async function run() {
        const warnings = true;
        const detailedReport = false;

        const assert = require('assert');
        const MochaRunner = require('nav-ally/MochaRunner');
        const runner = new MochaRunner();
        await runner.run({links: ['http://some-url.com'] }, {warnings, detailedReport}, result => {
            assert.ok(result.fails &lt; result.passes);
        });
     }

     @example &lt;caption>With promise chaining.&lt;/caption>

     function run() {
        const warnings = true;
        const detailedReport = false;

        const assert = require('assert');
        const MochaRunner = require('nav-ally/MochaRunner');
        const runner = new MochaRunner();
        return runner.run(
            {links: ['http://some-url.com'] }, {warnings, detailedReport}
        ).then(result => {
            assert.ok(result.fails &lt; result.passes);
        });
     }
 */
MochaRunner.prototype.run = async function(input, config = {}) {
    const self = this;
    return new Promise((resolve, reject) => {
        return self.__runValidator(resolve, self.input || input, self.config || config);
    });
};

MochaRunner.prototype.__runValidator = async function(resolve, input, config = {}, callback) {
    const mocha = new Mocha();

    let fails = 0;
    let passes = 0;
    const testFails = [];
    const testPasses = [];

    const name = config.name || NAME;
    const timeout = config.timeout || TIMEOUT;
    const assertWarnings = config.warnings || ASSERT_WARNINGS;

    const validator = new Validator(input, config);
    const results = await validator.run();

    const parentSuite = Suite.create(mocha.suite, name);

    results.forEach(page => {
        const suite = Suite.create(parentSuite, page.desc || page.link);
        suite.timeout(timeout);

        if (!this.__hasOption(page, 'options.test')) {
            this.__generateTests(suite, validator, page, assertWarnings);
        } else {
            if (!this.__hasOption(page, 'options.test.expect')) {
                const msg = 'Test option does not have an expectation for link ' +
                    (page.desc || page.link);
                error(msg,page.options.test);
                throw new Error(msg);
            }

            const expect = page.options.test.expect;

            if (expect.startsWith('fail')) {
                this.__generateInvertedTests(suite, validator, page, assertWarnings);
            } else if (expect.startsWith('pass')) {
                this.__generateTests(suite, validator, page, assertWarnings);
            } else {
                const msg = 'Unknown test expectation type: ' + expect;
                error(msg);
                throw new Error(msg);
            }
        }
    });

    mocha
        .run()
        .on('pass', function(test) {
            passes++;
            testPasses.push(test);
        })
        .on('fail', function(test, err) {
            fails++;
            testFails.push({test, err});
        })
        .on('end', function() {
            const resultset = {
                fails,
                passes,
                testFails,
                testPasses
            };
            if (resolve) resolve(resultset);
            if (callback) callback(resultset);

            return resultset;
        });
};

/**
 * Generates tests that is expected to pass without
 * any failures (violations or warnings).
 *
 * @param suite The Mocha test suite to add the test to
 * @param validator The validator class to validate containing the test results
 * @param page The page to generate tests to
 * @param assertWarnings If true, ignores assertion of warnings.
 * @memberOf MochaRunner
 * @private
 */
MochaRunner.prototype.__generateTests = function(suite, validator, page, assertWarnings) {
    suite.addTest(
        new Test('should have no accessibility violations', partDone => {
            assert.strictEqual(
                validator.getViolationsOnPage(page),
                0,
                'Accessibility violations found.'
            );
            partDone();
        })
    );

    if (assertWarnings) {
        suite.addTest(
            new Test('should have no accessibility warnings', partDone => {
                assert.strictEqual(
                    validator.getWarningsOnPage(page),
                    0,
                    'Accessibility warnings found.'
                );
                partDone();
            })
        );
    }
};

/**
 * Generates tests that is expected to fail, either on
 * any failures (violations + warnings), or only violations
 * or warnings. The 'expect' option can have one of three
 * values: fail, fail-warnings, fail-violations. The last two
 * will fail only on violations, or only on warnings.
 * Add the key option.test.expect to your config.
 *
 * @example &lt;caption>Test expectation&lt;/caption>
     links:
     - link: "http://www.test.com/"
     options:
     test:
     expect: "to-fail"
 *
 * @param suite The Mocha test suite to add the test to
 * @param validator The validator class to validate containing the test results
 * @param page The page to generate tests to
 * @param assertWarnings If true, ignores assertion of warnings.
 * @memberOf MochaRunner
 * @private
 */
MochaRunner.prototype.__generateInvertedTests = function(suite, validator, page, assertWarnings) {
    const expect = page.options.test.expect;

    if (this.__assertTestOptions(expect, 'fail')) {
        const totalFails =
            validator.getValidationErrors() + validator.getWarnings();
        suite.addTest(
            new Test('should have accessibility issues', partDone => {
                assert.ok(totalFails > 0, 'Accessibility issues expected, none found.');
                partDone();
            })
        );
    } else if (this.__assertTestOptions(expect, 'fail-violations')) {
        suite.addTest(
            new Test('should have accessibility violations', partDone => {
                assert.ok(
                    validator.getViolationsOnPage(page) > 0,
                    'Accessibility violations expected, none found.'
                );
                partDone();
            })
        );
    } else if (assertWarnings &amp;&amp; this.__assertTestOptions(expect, 'fail-warnings')) {
        suite.addTest(
            new Test('should have accessibility warnings', partDone => {
                assert.ok(
                    validator.getWarningsOnPage(page) > 0,
                    'Accessibility warnings expected, none found.'
                );
                partDone();
            })
        );
    } else {
        const msg = 'Unknown test expectation type: ' + expect;
        error(msg);
        throw new Error(msg);
    }
};

MochaRunner.prototype.__hasOption = function(option, optionPath) {
    return _.has(option, optionPath);
};

MochaRunner.prototype.__assertTestOptions = function(expect, option) {
    const contains = (string, array) =>
        array.map(key => key.toLowerCase()).indexOf(string) > -1;
    return (
        (Array.isArray(expect) &amp;&amp; contains(option.toLowerCase())) ||
        expect === option
    );
};

module.exports = MochaRunner;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>

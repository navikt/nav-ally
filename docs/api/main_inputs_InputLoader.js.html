<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>main/inputs/InputLoader.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="InputLoader.html">InputLoader</a><ul class='methods'><li data-type='method'><a href="InputLoader.html#.loadInputFromEnvironment">loadInputFromEnvironment</a></li></ul></li><li><a href="Validator.html">Validator</a><ul class='methods'><li data-type='method'><a href="Validator.html#__addBrowser">__addBrowser</a></li><li data-type='method'><a href="Validator.html#__authenticate">__authenticate</a></li><li data-type='method'><a href="Validator.html#__commandChaining">__commandChaining</a></li><li data-type='method'><a href="Validator.html#__commands">__commands</a></li><li data-type='method'><a href="Validator.html#__commandSelector">__commandSelector</a></li><li data-type='method'><a href="Validator.html#__countAllInCompleteOccurrences">__countAllInCompleteOccurrences</a></li><li data-type='method'><a href="Validator.html#__countAllViolationOccurrences">__countAllViolationOccurrences</a></li><li data-type='method'><a href="Validator.html#__countViolationOccurrences">__countViolationOccurrences</a></li><li data-type='method'><a href="Validator.html#__selectOption">__selectOption</a></li><li data-type='method'><a href="Validator.html#__validate">__validate</a></li><li data-type='method'><a href="Validator.html#closeAllBrowsers">closeAllBrowsers</a></li><li data-type='method'><a href="Validator.html#createChrome">createChrome</a></li><li data-type='method'><a href="Validator.html#createDefaultBrowser">createDefaultBrowser</a></li><li data-type='method'><a href="Validator.html#createFirefox">createFirefox</a></li><li data-type='method'><a href="Validator.html#getValidationErrors">getValidationErrors</a></li><li data-type='method'><a href="Validator.html#getViolationsOnPage">getViolationsOnPage</a></li><li data-type='method'><a href="Validator.html#getWarnings">getWarnings</a></li><li data-type='method'><a href="Validator.html#getWarningsOnPage">getWarningsOnPage</a></li><li data-type='method'><a href="Validator.html#printReportToConsole">printReportToConsole</a></li><li data-type='method'><a href="Validator.html#run">run</a></li><li data-type='method'><a href="Validator.html#startNewBrowser">startNewBrowser</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ASSERT_WARNINGS">ASSERT_WARNINGS</a></li><li><a href="global.html#BROWSER">BROWSER</a></li><li><a href="global.html#CHROME_BINARY">CHROME_BINARY</a></li><li><a href="global.html#DEBUG">DEBUG</a></li><li><a href="global.html#DEFINITION_FILE">DEFINITION_FILE</a></li><li><a href="global.html#DETAILED_REPORT">DETAILED_REPORT</a></li><li><a href="global.html#FIREFOX_BINARY">FIREFOX_BINARY</a></li><li><a href="global.html#HEADLESS">HEADLESS</a></li><li><a href="global.html#NAME">NAME</a></li><li><a href="global.html#runTestSuite">runTestSuite</a></li><li><a href="global.html#runValidator">runValidator</a></li><li><a href="global.html#TAGS">TAGS</a></li><li><a href="global.html#TIMEOUT">TIMEOUT</a></li><li><a href="global.html#WAIT_TIMEOUT">WAIT_TIMEOUT</a></li><li><a href="global.html#YAML_DEFINITION">YAML_DEFINITION</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">main/inputs/InputLoader.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const yaml = require('js-yaml');
const fs = require('fs');
const path = require('path');
const {log, error, trace} = require('../log/log');

/**
 * @class InputLoader
 */
function InputLoader() {} /* eslint-disable-line no-unused-vars */

/**
 * Loads files from one of two possible environment variables.
 *
 * @memberOf InputLoader
 * @param definitionFile Loads config from an external definition file.
 * @param yamlFile Loads config from a yaml object.
 * @returns {*}
 */
function loadInputFromEnvironment(definitionFile, yamlFile) {
  if (definitionFile) {
    return handleInputFromDefinitionFile(definitionFile);
  }

  if (yamlFile) {
    if (typeof yamlFile === 'string') {
      return handleInputFromYaml(yamlFile);
    } else {
      trace('\nExpected yaml input to be string.\n', yamlFile);
      process.exit(1);
    }
  }

  error('\nNo input has been configured.');
  error(
    'Use the environment variable DEFINITION_FILE to load input from file.'
  );
  process.exit(1);
}

function handleInputFromYaml(yamlFile) {
  log('Loading yaml definition.');
  const yamlObj = preProcessYaml(yaml.safeLoad(yamlFile));
  log('YAML object loaded:', yamlObj);
  return yamlObj;
}

function handleInputFromDefinitionFile(definitionFile) {
  const realPath = path.resolve(definitionFile);

  if (!definitionFile) {
    trace(
      'Invalid input. Did you forget to set the DEFINITION_FILE environment variable?'
    );
    process.exit(1);
  }

  let validationFileExists = fs.existsSync(realPath);

  if (validationFileExists) {
    return loadDefinitionFile(definitionFile, realPath);
  } else {
    trace('The specified file was not found: ' + realPath);
    process.exit(1);
  }
}

function loadDefinitionFile(name, file) {
  if (file.endsWith('.js')) {
    console.log('Loading Javascript definition file: ' + name);
    let jsObj = require(file);
    validateInputObject(jsObj);
    return jsObj;
  } else if (file.endsWith('.yml') || file.endsWith('.yaml')) {
    try {
      log('Loading Yaml definition file: ' + name);
      const yamlObj = preProcessYaml(yaml.safeLoad(fs.readFileSync(file)));
      log('YAML object loaded:', yamlObj);
      return yamlObj;
    } catch (err) {
      error('An error occurred while loading YAML definition file.');
      trace(err);
      process.exit(1);
    }
  } else {
    trace('Unsupported definition file.');
    process.exit(1);
  }
}

function preProcessYaml(yamlObj) {
  console.log('Preprocessing YAML object read:', yamlObj);
  if (yamlObj.links) {
    yamlObj.links = yamlObj.links.map(link => {
      if (typeof link === 'string') {
        return {link: link};
      } else if (typeof link === 'object') {
        return link;
      }
    });
    return yamlObj;
  } else {
    return {links: []};
  }
}

function validateInputObject(jsObj) {
  if (jsObj.links) {
    if (Array.isArray(jsObj.links)) {
      validateJavaScriptInputLinks(jsObj.links);
      console.log('JavaScript input is validated OK.');
    } else {
      console.error('Javascript input definition is not an array.');
      console.error(
        "Expected format: [ {link: 'http://abc.com'}, {link: 'http://def.com'}, etc... ]"
      );
      process.exit(1);
    }
  } else {
    console.error(
      "Javascript input definition is not valid. Must be an object and have a field named 'links'."
    );
    console.error(
      "Expected format: { links = [ {link: 'http://abc.com'}, {link: 'http://def.com'}, etc... ] }"
    );
    console.error(
      'See https://github.com/navikt/pus-uu-validator/blob/master/README.md for more information.'
    );
    process.exit(1);
  }
}

function validateJavaScriptInputLinks(links) {
  const isString = input => typeof input === 'string';

  links.forEach(input => {
    if (typeof input === 'object') {
      if (!input.link) {
        handleInvalidInput(
          input,
          "JavaScript input is invalid. Field 'link' is missing."
        );
      }
      if (!isString(input.link)) {
        handleInvalidInput(input, "Value of field 'link' is not a string.");
      }
    } else {
      handleInvalidInputType();
    }
  });
}

function getBooleanValue(property, propertyName) {
  if (property === 'true' || property === true) return true;
  if (property === 'false' || property === false) return false;

  console.error(propertyName + ' property should be either true or false.');
  process.exit(1);
}

function handleInvalidInputType() {
  console.error('Invalid input type. Must be a string or an object.');
  console.error(
    'See https://github.com/navikt/pus-uu-validator/blob/master/README.md for more information.'
  );
  process.exit(1);
}

function handleInvalidInput(input, msg) {
  console.error(msg);
  console.error('Check the following input:');
  console.error(input);
  process.exit(1);
}

exports.loadInputFromEnvironment = loadInputFromEnvironment;
exports.handleInputFromYaml = handleInputFromYaml;
exports.handleInputFromDefinitionFile = handleInputFromDefinitionFile;
exports.loadDefinitionFile = loadDefinitionFile;
exports.preProcessYaml = preProcessYaml;
exports.validateInputObject = validateInputObject;
exports.validateJavaScriptInputLinks = validateJavaScriptInputLinks;
exports.getBooleanValue = getBooleanValue;
exports.handleInvalidInputType = handleInvalidInputType;
exports.handleInvalidInput = handleInvalidInput;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
